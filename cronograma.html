<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cronograma - SistemaTaloes (v5 - resumo estilo Excel)</title>
  <style>
    :root { --bg:#f4f4f4; --ink:#333; --ink-2:#555; --card:#fff; --muted:#777;
      --pri:#007bff; --pri-700:#0056b3; --danger:#dc3545; --danger-700:#c82333; --ok:#345fec; --bd:#ddd; --chip:#f0f0f0; }
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;min-height:100vh;display:flex;flex-direction:column}
    header{background:#333;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,.2)}
    header h1{margin:0;font-size:22px}
    .user-info{font-size:13px;text-align:right}
    .user-info span{display:block;font-weight:700}
    nav {background-color: #555; padding: 10px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 0.8em}
    nav ul{list-style:none;margin:0;padding:0;display:flex;gap:12px;flex-wrap:wrap}
    nav a{color:#fff;text-decoration:none;padding:6px 12px;border-radius:6px;display:block}
    nav a:hover{background:#777}
    .main-content{flex:1;padding:16px;display:flex;flex-direction:column;align-items:center}
    /* Aumento o gap e centralizo para acomodar os novos botões */
    .filters-container{background:var(--card);padding:10px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);width:100%;max-width:95%;margin-bottom:14px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:flex-end}
    .form-group{display:flex;flex-direction:column;min-width:120px}
    .filters-container label{margin-bottom:3px;color:var(--ink-2);font-weight:700;font-size:.8em}
    .filters-container input,.filters-container select{padding:8px;border:1px solid #ccc;border-radius:8px;font-size:.9em}
    .btn{padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-size:.9em;transition:background .2s,transform .02s;display:inline-flex;gap:.5rem;align-items:center}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-primary:hover{background:var(--pri-700)}
    .btn-secondary{background:#e9ecef;color:#111}
    .btn-secondary:hover{background:#dde2e6}
    /* Estilo para os botões de Resumo */
    .btn-resumo{background:#6c757d;color:#fff; min-width: 140px;}
    .btn-resumo:hover{background:#5a6268}
    /* NOVO: Estilo para o container dos botões de resumo dentro do relatório */
    #resumoButtonsContainer {
        display: flex; 
        gap: 12px; 
        margin: 12px 0; 
        padding: 8px 0;
        border-top: 1px dashed var(--bd);
        border-bottom: 1px dashed var(--bd);
        justify-content: center;
        width: 100%;
    }


    #logoutButton{background:var(--danger);color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer}
    #logoutButton:hover{background:var(--danger-700)}
    .container{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,.08);width:100%;max-width:1200px}
    .summary-info{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start;background:var(--chip);padding:8px;border-radius:8px;margin-bottom:12px;font-size:.9em}
    .summary-item{
      background:#fff;border:1px solid var(--bd);border-radius:10px;padding:8px 10px;text-align:center;
      flex-grow: 1; 
      min-width: 100px;
    }
    .summary-item strong{display:block;font-size:1.15em}
    /* Estilos para os novos filtros (links) */
    .filter-link {
        cursor: pointer;
        text-decoration: none;
        color: var(--ink);
        transition: background .1s;
    }
    .filter-link:hover {
        background: #e0e0e0;
    }
    .filter-link.active-filter {
        background: #add8e6; /* Azul claro para filtro ativo */
        border: 1px solid var(--pri);
    }
    
    /* Regra para ocultar colunas */
    .hidden-column {
        display: none !important;
    }

    /* Estilo para o Menu de Controle de Colunas e Linhas */
    #columnControlMenu, #lineFilterContainer {
        background: var(--card);
        padding: 10px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,.08);
        width: 100%;
        max-width: 1200px;
        margin-bottom: 14px;
        text-align: left;
        font-size: 0.9em;
        border: 1px solid var(--bd);
    }
    #columnControlMenu h4, #lineFilterContainer h4 {
        margin: 0 0 8px 0;
        color: var(--ink-2);
    }
    .column-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 15px;
    }
    .column-checkboxes label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: normal;
    }
    .column-checkboxes input[type="checkbox"] {
        margin-right: 5px;
    }

    .table-container{width:100%;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:.78em}
    th,td{padding:5px 6px;text-align:center;border:1px solid var(--bd);white-space:nowrap}
    thead th{background:#f2f2f2;font-weight:700}
    .separator-border{border-right:3px solid #666}

    .exportacao-row:nth-child(odd) { background-color: #add8e6; } /* Azul claro */
    .exportacao-row:nth-child(even) { background-color: #6dd6ff; } /* Azul mais escuro */

    .cliente-especial-row:nth-child(odd) { background-color: #ffdfe3; } /* Rosa claro */
    .cliente-especial-row:nth-child(even) { background-color: #d6a4bd; } /* Rosa mais escuro */

    .mercado-interno-row:nth-child(odd) { background-color: #ffffff; } /* Branco */
    .mercado-interno-row:nth-child(even) { background-color: #f5f5f5; } /* Cinza claro */

    .estoque-row:nth-child(odd) { background-color: #fdfd96; } /* Amarelo claro */
    .estoque-row:nth-child(even) { background-color: #b8b874; } /* Amarelo mais escuro */

    .amostra-row:nth-child(odd) { background-color: #90ee90; } /* Verde claro */
    .amostra-row:nth-child(even) { background-color: #6b9c6b; } /* Verde mais escuro */

    .remessa-link{color:var(--ink);text-decoration:underline;cursor:pointer}
    .remessa-link:hover{color:#000000}
    .loader{text-align:center;padding:16px;color:#555}
    .status-check{color:var(--ok);font-weight:500}
    /* Modal */
    .modal{display:none;position:fixed;z-index:10;inset:0;background:rgba(0,0,0,.4);padding:12px}
    .modal-content{background:#fff;margin:auto;padding:12px;border:1px solid #888;width:98%;max-width:1400px;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.2);animation:animatetop .25s;position:relative}
    @keyframes animatetop{from{transform:translateY(-10px);opacity:0}to{transform:translateY(0);opacity:1}}
    .close-btn{position:absolute;right:10px;top:6px;color:#888;font-size:26px;font-weight:700;cursor:pointer}
    .close-btn:hover{color:#000}
    .modal-head{display:flex;gap:8px;align-items:center;justify-content:space-between}
    /* CLASSE APLICADA À ESTRUTURA DA TABELA DE DETALHES */
    #detailsTableContainer {
        overflow:auto; 
        max-height:80vh;
        /* Garante que o container da tabela de detalhes tenha uma altura máxima e scroll */
    }
    .modal-body-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:.8em;table-layout:auto}
    .modal-body-table th,.modal-body-table td{border:1px solid var(--bd);padding:6px;text-align:center;white-space:nowrap}
    .modal-body-table th{background:#f2f2f2}
    
    /* Estilos Específicos para Resumo (Cards) - Usado para Giro, Corte e Costura */
    .resumo-cards-wrapper { /* Novo wrapper para os cards de resumo */
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 15px;
        max-height: 80vh; /* Limite de altura para o scroll */
        overflow-y: auto; /* Adiciona scroll se necessário */
        padding-right: 15px; /* Espaço para a barra de rolagem */
    }
    .atelie-card {
        border: 1px solid var(--bd);
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        background-color: var(--chip);
        display: flex;
        flex-direction: column;
    }
    .atelie-card h4 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 1.1em;
        color: var(--pri-700);
        border-bottom: 2px solid var(--pri);
        padding-bottom: 4px;
    }
    .model-list {
        flex-grow: 1; /* Permite que a lista cresça e ocupe o espaço */
    }
    .model-list p {
        margin: 4px 0;
        font-size: 0.9em;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
    }
    .model-list span:last-child {
        font-weight: 700;
        color: var(--ink-2);
    }
    /* NOVO: Estilo para o total de pares dentro de cada card */
    .card-total {
        margin-top: 10px !important; 
        padding-top: 5px;
        border-top: 1px dashed var(--muted);
        font-size: 1.0em !important;
        font-weight: 700 !important;
        color: var(--ink); /* Cor padrão */
    }
    .card-total span:last-child {
        color: var(--pri) !important; /* Destaque azul para o total do card */
    }
    
    /* Estilos específicos para a tabela dentro do modal de remessa */
    #remessaFilterTable th, #remessaFilterTable td {
        padding: 6px;
        border: 1px solid var(--bd);
        white-space: normal;
    }
    #remessaFilterTable th {
        background-color: #f2f2f2;
    }
    #remessaFilterTable tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    @media (max-width:768px){.filters-container{justify-content:stretch}.form-group{flex:1}.modal-content{width:98%;max-width:98%}.modal-body-table{font-size:.74em}}
    .modal-body-table tr:nth-child(even) {background-color: #f2f2f2;}
  </style>
</head>
<body>
  <header>
    <h1>SistemaTaloes</h1>
    <div class="user-info">
      <span id="userNameDisplay">Carregando...</span>
      <span id="userNivelDisplay"></span>
    </div>
    <div><button id="logoutButton">Sair</button></div>
  </header>
  <nav><ul id="menuNav"></ul></nav>
  <div class="main-content">
    <div class="filters-container">
      <div class="form-group"><label for="filterLinha">Linha:</label><input type="text" id="filterLinha" placeholder="Ex: 100" /></div>
      <div class="form-group" style="display: flex; flex-direction: column; align-items: stretch; min-width: 120px;">
          <label for="filterRemessa" style="margin-bottom: 3px;">Remessa:</label>
          <div style="display: flex; gap: 5px;">
              <input type="text" id="filterRemessa" placeholder="Ex: 2684982" style="flex-grow: 1;"/>

          </div>
      </div>
      <div class="form-group"><label for="filterDataCorteInicio">Data de Corte (Início):</label><input type="date" id="filterDataCorteInicio" /></div>
      <div class="form-group"><label for="filterDataCorteFim">Data de Corte (Fim):</label><input type="date" id="filterDataCorteFim" /></div>
      <div class="form-group"><label for="filterTipoCliente">Tipo de Cliente:</label>
        <select id="filterTipoCliente">
          <option value="">Todos</option>
          <option value="Exportacao">Exportação</option>
          <option value="Cliente especial">Cliente Especial</option>
          <option value="Mercado Interno">Mercado Interno</option>
          <option value="Estoque">Estoque</option>
          <option value="Amostra">Amostra</option>
        </select>
      </div>
      <div class="form-group"><label for="filterAtelie">Ateliê Responsável:</label>
        <select id="filterAtelie"><option value="">Todos</option></select>
      </div>
      <div class="form-group"><label for="filterDataEntregaInicio">Data de Entrega (Início):</label><input type="date" id="filterDataEntregaInicio" /></div>
      <div class="form-group"><label for="filterDataEntregaFim">Data de Entrega (Fim):</label><input type="date" id="filterDataEntregaFim" /></div>
      <button class="btn btn-primary" id="searchButton">Gerar Relatório</button>
      <button class="btn btn-secondary" id="clearFiltersButton" title="Limpar filtros">Limpar</button>
      
      </div>
    <div class="container">
      <h2>Relatório de Cronograma</h2>
        <div id="lineFilterContainer" class="filters-container" style="display:none; justify-content: flex-start; max-width: 1200px; margin-bottom: 14px; align-items: flex-start;">
            <h4 style="margin: 5px 10px 0 0; color: var(--ink-2); font-size: 1em;">Filtrar Linhas:</h4>
            <div id="lineCheckboxes" class="column-checkboxes">
                </div>
               <button class="btn btn-secondary" id="selectRemessasButton" disabled style="padding: 0 20; min-width: 120px;">
                  <span id="remessaCount">0</span> Clique para Selecionar as Remessas
              </button>


        </div>
      <div id="loading" class="loader" style="display:none">Carregando dados...</div>
      <div id="noData" class="loader">Selecione ao menos um filtro para iniciar a busca.</div>
      <div id="reportContent" style="display:none">
        
        <div id="summaryInfo" class="summary-info"></div>

        <div id="resumoButtonsContainer">
            <button class="btn btn-resumo" id="resumoCorteButton">Corte</button>
            <button class="btn btn-resumo" id="resumoCosturaButton">Giro Costura</button>
            <button class="btn btn-resumo" id="resumoGiroFabricaButton">Giro Fábrica</button>
        </div>
        <div id="columnControlMenu">
          <h4>Mostrar Colunas:</h4>
          <div id="checkboxContainer" class="column-checkboxes">
            </div>
        </div>
        <div id="tableContainer" class="table-container">
          <table>
            <thead>
              <tr>
                <th rowspan="2" class="col-linha">Linha</th>
                <th rowspan="2" class="col-remessa">Remessa</th>
                <th rowspan="2" class="col-pares-ident">Pares</th> 
                <th rowspan="2" class="col-taloes-ident">Talões</th> 
                <th rowspan="2" class="col-data-corte">Data de Corte</th>
                <th rowspan="2" class="col-data-entrega">Data de Entrega</th>
                
                <th colspan="2" class="separator-border col-corte-group">Cortar</th>
                <th colspan="2" class="separator-border col-costura-group">Costurar</th>
                <th colspan="2" class="separator-border col-distribuicao-group">Distribuir</th>
                <th colspan="2" class="separator-border col-talonagem-group">Talonar</th>
                <th colspan="2" class="col-montagem-group">Montar</th>
              </tr>
              <tr>
                <th class="col-corte">Pares</th><th class="separator-border col-corte">Talões</th>
                <th class="col-costura">Pares</th><th class="separator-border col-costura">Talões</th>
                <th class="col-distribuicao">Pares</th><th class="separator-border col-distribuicao">Talões</th>
                <th class="col-talonagem">Pares</th><th class="separator-border col-talonagem">Talões</th>
                <th class="col-montagem">Pares</th><th class="col-montagem">Talões</th>
              </tr>
            </thead>
            <tbody id="cronogramaTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <div id="detailsModal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <div class="modal-head"><h3 id="modalTitle" style="margin:0">Detalhes / Resumo</h3></div>
      <div id="modalBodyContent">
          </div>
    </div>
  </div>

  <div id="remessaFilterModal" class="modal">
    <div class="modal-content" style="max-width: 650px;">
      <span class="close-btn remessa-close-btn">&times;</span>
      <div class="modal-head"><h3 style="margin:0">Selecionar Remessas (Filtro)</h3></div>
      <p style="font-size: 0.9em; color: var(--muted);">
          *A busca é limitada às remessas carregadas no relatório principal.<br>
          **Os dados de pares/linha/cliente são a consolidação de todos os talões da remessa.
      </p>
      <div id="remessaFilterListContainer" style="max-height: 400px; overflow-y: auto; padding: 8px 0;">
        <table id="remessaFilterTable" style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
            <thead>
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="selectAllRemessas" checked></th>
                    <th>Remessa</th>
                    <th>Linha(s)</th>
                    <th>Pares Totais</th>
                    <th>Tipo de Cliente</th>
                </tr>
            </thead>
            <tbody id="remessaFilterTableBody"></tbody>
        </table>
      </div>
      <div style="display: flex; justify-content: flex-end; padding-top: 10px; border-top: 1px solid var(--bd);">
        <button class="btn btn-primary" id="saveRemessaSelectionButton">Salvar Seleção</button>
      </div>
    </div>
  </div>
  <script type="module">
    // === Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyCLb8BeZODM8vMynaIXINx4AN_P8snTBk8",
      authDomain: "sistemataloes.firebaseapp.com",
      projectId: "sistemataloes",
      storageBucket: "sistemataloes.appspot.com",
      messagingSenderId: "684534379685",
      appId: "1:684534379685:web:..."
    };
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

    // === DOM ===
    const menuNav=document.getElementById('menuNav'), userNameDisplay=document.getElementById('userNameDisplay'), userNivelDisplay=document.getElementById('userNivelDisplay'), logoutButton=document.getElementById('logoutButton');
    const filterLinha=document.getElementById('filterLinha'), filterRemessa=document.getElementById('filterRemessa'), filterDataCorteInicio=document.getElementById('filterDataCorteInicio'), filterDataCorteFim=document.getElementById('filterDataCorteFim'), filterTipoCliente=document.getElementById('filterTipoCliente'), filterAtelie=document.getElementById('filterAtelie'), filterDataEntregaInicio=document.getElementById('filterDataEntregaInicio'), filterDataEntregaFim=document.getElementById('filterDataEntregaFim');
    const searchButton=document.getElementById('searchButton'), clearFiltersButton=document.getElementById('clearFiltersButton');
    
    // NOVAS REFERÊNCIAS DE BOTÕES (AGORA NO CORPO DO RELATÓRIO)
    const resumoCorteButton=document.getElementById('resumoCorteButton'), resumoCosturaButton=document.getElementById('resumoCosturaButton'), resumoGiroFabricaButton=document.getElementById('resumoGiroFabricaButton');
    
    const loading=document.getElementById('loading'), noData=document.getElementById('noData'), reportContent=document.getElementById('reportContent'), summaryInfo=document.getElementById('summaryInfo'), cronogramaTableBody=document.getElementById('cronogramaTableBody');
    const detailsModal=document.getElementById('detailsModal'), modalTitle=document.getElementById('modalTitle'), closeModalBtn=document.querySelector('.close-btn');
    const modalBodyContent = document.getElementById('modalBodyContent'); 
    const checkboxContainer = document.getElementById('checkboxContainer'); 
    
    // NOVO: Referências para o controle de Linhas
    const lineFilterContainer = document.getElementById('lineFilterContainer');
    const lineCheckboxes = document.getElementById('lineCheckboxes');

    // NOVO: Referências para o controle de Remessas
    const selectRemessasButton = document.getElementById('selectRemessasButton');
    const remessaCount = document.getElementById('remessaCount');
    const remessaFilterModal = document.getElementById('remessaFilterModal');
    const remessaCloseBtn = document.querySelector('.remessa-close-btn');
    const remessaFilterTableBody = document.getElementById('remessaFilterTableBody');
    const selectAllRemessas = document.getElementById('selectAllRemessas');
    const saveRemessaSelectionButton = document.getElementById('saveRemessaSelectionButton');
    
    // Variável para a tabela de detalhes
    let modalTableBody = null; 
    
    let allFetchedTaloes=[];
    let currentStageFilter = null; 
    
    // NOVO: Variáveis de estado para o filtro de Linhas
    let availableLines = new Set();
    let selectedLines = new Set(); // Armazena as linhas atualmente selecionadas/filtradas

    // NOVO: Variáveis de estado para o filtro de Remessas
    // Map<remessaNumber, {linhas: Set, pares: number, tiposCliente: Set}>
    let availableRemessas = new Map(); 
    let selectedRemessas = new Set();  // Set<remessaNumber>


    // Tipos de Usuarios e niveis
        const nivelNomes = {
            '01': 'Cadastro', '02': 'Corte', '03': 'Costura', '04': 'Montagem',
            '05': 'Admin', '06': 'Consultor', '07':'Super'
        };

        // Definição das páginas e seus níveis de acesso 
        const pages = [
            { name: 'Index', href: 'index.html', levels: ['01','02','03', '04','05', '06','07'] },
            { name: 'Cadastro Usuarios', href: 'cadastroUsuarios.html', levels: ['07'] },
            { name: 'Cadastro Talões', href: 'cadastroTaloes.html', levels: ['01', '05','07'] },
            { name: 'Romaneio', href: 'romaneio.html', levels: ['05','07'] },
            { name: 'Excluir Dados', href: 'excluirDados.html', levels: ['05','07'] },
            { name: 'Registro em Massa', href: 'registroEmMassa.html', levels: ['07'] },
            { name: 'Corte', href: 'corte.html', levels: ['02','07'] },
            { name: 'Relatório Erros', href: 'relatorioerros.html', levels: ['02','04','07'] },
            { name: 'Resumo', href: 'resumo.html', levels: ['04','06','07'] },
            { name: 'Cronograma', href: 'cronograma.html', levels: ['01','02', '04','05','06','07'] },
            { name: 'Cronograma Mobile', href: 'cronogramamobile.html', levels: ['06','07'] },
            { name: 'Relatório Master', href: 'relatorioMaster.html', levels: ['05','07'] },
            { name: 'Costura', href: 'costura.html', levels: ['03','07'] },
            { name: 'Relatorio Atelier', href: 'relatorioAtelier.html', levels: ['03','07'] },
            { name: 'Atlier Celular', href: 'relatoriomobile.html', levels: ['03','07'] },
            { name: 'Distribuição', href: 'distribuicao.html', levels: ['04','07'] },
            { name: 'Talonagem', href: 'talonagem.html', levels: ['04','07'] },
            { name: 'Montagem', href: 'montagem.html', levels: ['05','07'] }
        ];

    //Funçoes

    function generateMenu(userLevel,userName){menuNav.innerHTML='';const userNivelText=nivelNomes[userLevel]||`Nível ${userLevel}`;userNameDisplay.textContent=`Olá, ${userName||'Usuário'}!`;userNivelDisplay.textContent=`Setor: ${userNivelText}`;pages.forEach(p=>{if(p.levels.includes(userLevel)){const li=document.createElement('li');const a=document.createElement('a');a.href=p.href;a.textContent=p.name;li.appendChild(a);menuNav.appendChild(li);}});}
    onAuthStateChanged(auth, async (user)=>{ if(!user){window.location.href='login.html';return;} const snap=await getDoc(doc(db,'Usuario',user.email)); if(!snap.exists()){alert('Dados do usuário não encontrados. Faça login novamente.'); await signOut(auth); window.location.href='login.html'; return;} const {nivelAcesso,Nome}=snap.data(); if(!pages.find(p=>p.href==='cronograma.html'&&p.levels.includes(nivelAcesso))){alert('Você não tem permissão para acessar esta página.'); window.location.href='index.html'; return;} generateMenu(nivelAcesso,Nome); loadAtelies(); setupColumnControl();}); 
    logoutButton.addEventListener('click', async()=>{ try{ await signOut(auth); window.location.href='login.html'; }catch(e){ console.error(e); alert('Erro ao fazer logout. Tente novamente.'); }});
    async function loadAtelies(){ try{ const qSnap=await getDocs(query(collection(db,'Usuario'), where('nivelAcesso','==','03'))); const names=qSnap.docs.map(d=>d.data().Nome).filter(Boolean).sort((a,b)=>a.localeCompare(b)); names.forEach(n=>{const opt=document.createElement('option'); opt.value=n; opt.textContent=n; filterAtelie.appendChild(opt);}); }catch(err){ console.error('Erro ao carregar ateliês:',err);} }
    
    // MODIFICADO: Limpa também os filtros de linha e remessa
    clearFiltersButton.addEventListener('click',()=>{ 
        [filterLinha,filterRemessa,filterDataCorteInicio,filterDataCorteFim,filterDataEntregaInicio,filterDataEntregaFim].forEach(i=>i.value=''); 
        filterTipoCliente.value=''; 
        filterAtelie.value=''; 
        cronogramaTableBody.innerHTML=''; 
        summaryInfo.innerHTML=''; 
        reportContent.style.display='none'; 
        noData.textContent='Selecione ao menos um filtro para iniciar a busca.'; 
        noData.style.display='block'; 
        currentStageFilter = null; 
        
        // NOVO: Limpeza dos filtros de linha
        lineFilterContainer.style.display = 'none'; 
        availableLines = new Set(); 
        selectedLines = new Set();

        // NOVO: Limpeza dos filtros de remessa
        remessaFilterModal.style.display = 'none';
        selectRemessasButton.disabled = true;
        selectRemessasButton.textContent = '0 Selecionadas';
        availableRemessas = new Map();
        selectedRemessas = new Set();
    });
    
    searchButton.addEventListener('click', runSearch);

    // Helpers
    function hasDate(v){ return v!==undefined && v!==null && String(v).trim()!==''; }
    function formatDate(iso){ if(!iso) return ''; const [y,m,d]=iso.split('-'); if(!y||!m||!d) return ''; return `${d}/${m}/${y}`; }
    function formatDateAbreviado(iso){ if(!iso) return ''; const dt=new Date(iso+'T00:00:00'); if(isNaN(dt)) return ''; const dd=String(dt.getDate()).padStart(2,'0'); const mm=String(dt.getMonth()+1).padStart(2,'0'); return `${dd}/${mm}`; }
    function maxISO(a,b){ if(!a) return b||null; if(!b) return a||null; return (new Date(a)>new Date(b))?a:b; }
    function groupAndSum(taloes, keyFunc) {
        const grouped = {};
        taloes.forEach(t => {
            const key = keyFunc(t);
            const pares = Number(t.pares) || 0;
            if (key) {
                grouped[key] = (grouped[key] || 0) + pares;
            }
        });
        return grouped;
    }
    
    // NOVO: Função para atualizar o texto do botão do filtro de remessa
    function updateRemessaCountDisplay() {
        const totalAvailable = availableRemessas.size;
        // remessaCount.textContent = selectedRemessas.size.toLocaleString(); // Não é mais necessário, usando o texto completo
        selectRemessasButton.textContent = `Clique para selecionar as remessas`;
    }

    // NOVO: Função para coletar e inicializar os dados de remessa para o filtro
    function setupRemessaFilter(taloes) {
        const remessaData = new Map();

        taloes.forEach(t => {
            const remessa = t.numeroRemessa;
            if (!remessa) return;
            
            const pares = Number(t.pares) || 0;
            const linha = t.linha || 'N/A';
            const tipoCliente = t.tipoCliente || 'N/A';

            if (!remessaData.has(remessa)) {
                remessaData.set(remessa, {
                    linhas: new Set(),
                    pares: 0,
                    tiposCliente: new Set()
                });
            }
            
            const data = remessaData.get(remessa);
            data.pares += pares;
            if (linha) data.linhas.add(linha);
            if (tipoCliente) data.tiposCliente.add(tipoCliente);
        });

        availableRemessas = remessaData;

        // Inicializa `selectedRemessas` se estiver vazio (primeiro load)
        if (selectedRemessas.size === 0) {
            remessaData.forEach((_, remessa) => selectedRemessas.add(remessa));
        }
        
        // Habilita o botão e atualiza a contagem
        selectRemessasButton.disabled = false;
        updateRemessaCountDisplay();
    }
    
    // NOVO: Função para obter os talões atualmente filtrados pelas linhas E remessas selecionadas
    function getCurrentFilteredTaloes() {
        if (allFetchedTaloes.length === 0) return [];
        
        // 1. Aplica o filtro de Linhas
        let filteredTaloes = allFetchedTaloes;
        const availableRemessaKeys = Array.from(availableRemessas.keys());

        // O filtro de Linha só é aplicado se houver linhas disponíveis e nem todas estiverem selecionadas
        if (availableLines.size > 0 && selectedLines.size > 0 && selectedLines.size < availableLines.size) {
            filteredTaloes = filteredTaloes.filter(t => selectedLines.has(t.linha));
        }
        
        // 2. Aplica o filtro de Remessas
        // O filtro de Remessa só é aplicado se houver remessas disponíveis e nem todas estiverem selecionadas
        if (availableRemessaKeys.length > 0 && selectedRemessas.size > 0 && selectedRemessas.size < availableRemessaKeys.length) {
            filteredTaloes = filteredTaloes.filter(t => selectedRemessas.has(t.numeroRemessa));
        }
        
        // Se a busca inicial for por um número de remessa (input de texto), o filtro de modal não se aplica, 
        // mas a lista de talões já vem pré-filtrada pelo Firebase (e o filtro de Linhas/Remessas no modal deve refletir isso).
        
        return filteredTaloes;
    }
    
    // NOVO: Função para renderizar e gerenciar o filtro de linhas (a mesma função original)
    function renderLineCheckboxes(taloes) {
        // 1. Coleta todas as linhas únicas dos talões
        const uniqueLines = new Set(taloes.map(t => t.linha).filter(Boolean));
        
        // 2. Atualiza a lista global de linhas disponíveis
        availableLines = uniqueLines;

        // 3. Se `selectedLines` estiver vazio (primeiro load após a busca), seleciona todas
        if (selectedLines.size === 0 && uniqueLines.size > 0) {
            selectedLines = new Set([...uniqueLines]);
        }
        
        // 4. Ordena as linhas
        const sortedLines = Array.from(uniqueLines).sort((a, b) => parseInt(a) - parseInt(b));

        // 5. Gera os Checkboxes
        lineCheckboxes.innerHTML = '';
        sortedLines.forEach(line => {
            const id = `line-filter-${line}`;
            
            const label = document.createElement('label');
            label.htmlFor = id;
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = id;
            checkbox.value = line;
            
            // Marca o checkbox se a linha estiver na lista de selecionadas
            checkbox.checked = selectedLines.has(line);

            checkbox.addEventListener('change', handleLineFilterChange);

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(line));
            lineCheckboxes.appendChild(label);
        });

        // 6. Exibe o container de controle
        lineFilterContainer.style.display = uniqueLines.size > 0 ? 'flex' : 'none';
        
        // 7. Chama a função de filtragem e geração do relatório
        filterAndGenerateReport();
    }
    
    // NOVO: Função para lidar com a mudança do checkbox de linha
    function handleLineFilterChange(event) {
        const line = event.target.value;
        if (event.target.checked) {
            selectedLines.add(line);
        } else {
            selectedLines.delete(line);
        }
        // Força a re-geração do relatório com o novo filtro
        filterAndGenerateReport();
    }
    
    // NOVO: Função para filtrar os dados e gerar o relatório (usada após o search e após a mudança do checkbox)
    function filterAndGenerateReport() {
        const filteredTaloes = getCurrentFilteredTaloes();
        
        // Re-gera o relatório (sumário e tabela) com os dados filtrados
        generateGroupedReport(filteredTaloes);
    }
    
    // NOVO: Função para coletar e formatar os filtros aplicados
    function getAppliedFiltersText() {
        const filters = [];
        
        // Filtro de linha no campo de texto (se houver, ele é o que prevalece na busca do Firebase)
        const linha = filterLinha.value.trim();
        if (linha) filters.push(`Linha (Busca): ${linha}`);
        
        // Filtro de linha nos checkboxes (se houver, após a busca)
        if (!linha && selectedLines.size > 0 && selectedLines.size < availableLines.size) {
            filters.push(`Linhas (Selecionadas): ${Array.from(selectedLines).sort().join(', ')}`);
        }

        const remessaText = filterRemessa.value.trim();
        if (remessaText) filters.push(`Remessa (Busca): ${remessaText}`);
        
        // Filtro de remessa nos checkboxes (se houver, após a busca)
        const availableRemessaKeys = Array.from(availableRemessas.keys());
        if (!remessaText && availableRemessaKeys.length > 0 && selectedRemessas.size > 0 && selectedRemessas.size < availableRemessaKeys.length) {
            filters.push(`Remessas (Selecionadas): ${selectedRemessas.size} de ${availableRemessaKeys.length}`);
        }

        const tipoCliente = filterTipoCliente.value;
        if (tipoCliente) filters.push(`Tipo Cliente: ${tipoCliente}`);
        
        const atelie = filterAtelie.value;
        if (atelie) filters.push(`Ateliê: ${atelie}`);

        // Datas de Corte
        const dcI = filterDataCorteInicio.value;
        const dcF = filterDataCorteFim.value;
        if (dcI && dcF) {
            filters.push(`Corte: ${formatDateAbreviado(dcI)} - ${formatDateAbreviado(dcF)}`);
        } else if (dcI) {
             filters.push(`Corte (Início): ${formatDateAbreviado(dcI)}`);
        } else if (dcF) {
             filters.push(`Corte (Fim): ${formatDateAbreviado(dcF)}`);
        }
        
        // Datas de Entrega
        const deI = filterDataEntregaInicio.value;
        const deF = filterDataEntregaFim.value;
        if (deI && deF) {
            filters.push(`Entrega: ${formatDateAbreviado(deI)} - ${formatDateAbreviado(deF)}`);
        } else if (deI) {
             filters.push(`Entrega (Início): ${formatDateAbreviado(deI)}`);
        } else if (deF) {
             filters.push(`Entrega (Fim): ${formatDateAbreviado(deF)}`);
        }
        
        if (filters.length === 0) {
            return ""; 
        }

        return ` Filtros: (${filters.join(' | ')})`;
    }


    // MODIFICADO: Adiciona a lógica de renderização e filtro de linhas após a busca
    async function runSearch(){
      loading.style.display='block'; noData.style.display='none'; reportContent.style.display='none'; cronogramaTableBody.innerHTML=''; allFetchedTaloes=[];
      lineFilterContainer.style.display='none'; // Esconde antes de uma nova busca
      selectRemessasButton.disabled = true;
      selectRemessasButton.textContent = '0 Selecionadas'; // Reset para o texto padrão


      const linha=filterLinha.value.trim(); const remessa=filterRemessa.value.trim(); const dataCorteInicio=filterDataCorteInicio.value; const dataCorteFim=filterDataCorteFim.value; const tipoCliente=filterTipoCliente.value; const atelieResponsavel=filterAtelie.value; const dataEntregaInicio=filterDataEntregaInicio.value; const dataEntregaFim=filterDataEntregaFim.value;
      try{
        let qRef=collection(db,'taloes'); let hasFilters=false;
        if(linha){ qRef=query(qRef, where('linha','==',linha)); hasFilters=true; }
        if(remessa){ qRef=query(qRef, where('numeroRemessa','==',remessa)); hasFilters=true; }
        if(tipoCliente){ qRef=query(qRef, where('tipoCliente','==',tipoCliente)); hasFilters=true; }
        if(atelieResponsavel){ qRef=query(qRef, where('idAtelieResponsavel','==',atelieResponsavel)); hasFilters=true; }
        if(dataCorteInicio && dataCorteFim){ qRef=query(qRef, where('dataCorte','>=',dataCorteInicio), where('dataCorte','<=',dataCorteFim)); hasFilters=true; }
        
        currentStageFilter = null;
        if(!hasFilters){ loading.style.display='none'; noData.textContent='Por favor, selecione ao menos um filtro para iniciar a busca.'; noData.style.display='block'; return; }
        
        const snap=await getDocs(qRef); 
        allFetchedTaloes=snap.docs.map(d=>d.data()); 
        
        // Aplica o filtro de data de entrega localmente
        if(dataEntregaInicio && dataEntregaFim){ 
            allFetchedTaloes=allFetchedTaloes.filter(t=> t.dataEntrega && t.dataEntrega>=dataEntregaInicio && t.dataEntrega<=dataEntregaFim ); 
        }
        
        loading.style.display='none'; 
        
        if(allFetchedTaloes.length>0){ 
            // NOVO: 1. Configura e prepara o filtro de remessas
            setupRemessaFilter(allFetchedTaloes);

            // NOVO: 2. Se a busca foi por uma Linha específica, o filtro de checkbox já deve começar apenas com ela.
            if(linha) selectedLines = new Set([linha]); 
            else selectedLines = new Set(); // Reset para que renderLineCheckboxes selecione todos disponíveis
            
            // NOVO: 3. Renderiza os checkboxes e dispara a geração do relatório
            renderLineCheckboxes(allFetchedTaloes);
        } else { 
            noData.textContent='Nenhum dado encontrado para os filtros selecionados.'; 
            noData.style.display='block'; 
            selectRemessasButton.disabled = true; // Garante que o botão fica desabilitado
        }
        
      }catch(err){ 
        console.error('Erro ao gerar relatório:',err); 
        loading.style.display='none'; 
        noData.textContent='Erro ao carregar os dados. Verifique o console.'; 
        noData.style.display='block'; 
      }
    }

    // MODIFICADO: Recebe talões já filtrados e lida com a exibição final
    function generateGroupedReport(taloes){
      const grouped={};
      let totalPares=0,totalTaloes=0;

      // --- SUMÁRIOS estilo Excel ---
      let paresSemCorte=0;        
      let paresCosturaConcl=0;    
      let paresDist=0;            
      let paresTalon=0;           
      let paresMont=0;            

      // MODIFICADO: Exibe/Oculta o reportContent baseado nos talões passados
      if(!taloes||taloes.length===0){ 
        noData.textContent='Nenhum dado encontrado para os filtros selecionados.'; 
        noData.style.display='block'; 
        reportContent.style.display='none'; 
        return; 
      }
        
      reportContent.style.display='block';
      noData.style.display='none';

      taloes.forEach(t=>{
        const linha=t.linha||'N/A'; const remessa=t.numeroRemessa||'N/A'; const tipo=t.tipoCliente||'';
        const dataCorte=t.dataCorte||'N/A'; const dataEntrega=t.dataEntrega||'N/A'; const pares=Number(t.pares)||0;
        totalPares+=pares; totalTaloes+=1;
        const key=`${remessa}-${linha}-${dataCorte}-${dataEntrega}`;
        if(!grouped[key]){ grouped[key]={ remessa,linha,tipoCliente:tipo, paresTotal:0,taloesTotal:0, dataCorte,dataEntrega,
          corte:{paresFaltando:0,taloesFaltando:0,allDone:true,maxDate:null},
          costura:{paresFaltando:0,taloesFaltando:0,allDone:true,maxDate:null},
          distribuicao:{paresFaltando:0,taloesFaltando:0,allDone:true,maxDate:null},
          talonagem:{paresFaltando:0,taloesFaltando:0,allDone:true,maxDate:null},
          montagem:{paresFaltando:0,taloesFaltando:0,allDone:true,maxDate:null}
        }; }
        const g=grouped[key]; g.paresTotal+=pares; g.taloesTotal+=1;

        // Corte completo?
        const corteOK = hasDate(t.cabedalData) && hasDate(t.forroData) && hasDate(t.aviamentoData);
        if(corteOK){
          const maior=[t.cabedalData,t.forroData,t.aviamentoData].reduce((m,cur)=>maxISO(m,cur),null);
          g.corte.maxDate = maxISO(g.corte.maxDate, maior);
        }else{
          g.corte.paresFaltando+=pares; g.corte.taloesFaltando+=1; g.corte.allDone=false;
          paresSemCorte += pares;
        }

        // Costura concluída?
        const costuraOK = hasDate(t.dataSaidaCostura);
        if(costuraOK){ g.costura.maxDate=maxISO(g.costura.maxDate, t.dataSaidaCostura); paresCosturaConcl += pares; }
        else { g.costura.paresFaltando+=pares; g.costura.taloesFaltando+=1; g.costura.allDone=false; }

        // Distribuição / Talonagem / Montagem
        const distOK = hasDate(t.dataEntradaDistribuicao);
        const talonOK = hasDate(t.dataEntradaTalonagem);
        const montOK  = hasDate(t.dataEntradaMontagem);
        if(distOK){ g.distribuicao.maxDate=maxISO(g.distribuicao.maxDate, t.dataEntradaDistribuicao); paresDist += pares; }
        else { g.distribuicao.paresFaltando+=pares; g.distribuicao.taloesFaltando+=1; g.distribuicao.allDone=false; }
        if(talonOK){ g.talonagem.maxDate=maxISO(g.talonagem.maxDate, t.dataEntradaTalonagem); paresTalon += pares; }
        else { g.talonagem.paresFaltando+=pares; g.talonagem.taloesFaltando+=1; g.talonagem.allDone=false; }
        if(montOK){ g.montagem.maxDate=maxISO(g.montagem.maxDate, t.dataEntradaMontagem); paresMont += pares; }
        else { g.montagem.paresFaltando+=pares; g.montagem.taloesFaltando+=1; g.montagem.allDone=false; }
      });

      const corte = paresSemCorte;
      const costura = totalPares - paresCosturaConcl;
      const paresFaltandoDistribuicao = totalPares - paresDist;
      const paresFaltandoTalonagem = totalPares - paresTalon;
      const montar = totalPares - paresMont;

      updateSummaryExcel(totalPares,totalTaloes,corte,costura,paresFaltandoDistribuicao,paresFaltandoTalonagem,montar);
      renderTable(grouped);
    }

    function updateSummaryExcel(totalPares,totalTaloes,corte,costura,distribuicao,talonagem,montagem){
      summaryInfo.innerHTML = `
        <div class="summary-item" style="background-color: var(--pri); color: white;">Total pares<br><strong>${totalPares.toLocaleString()}</strong></div>
        <div class="summary-item" style="background-color: var(--pri); color: white;">Talões Filtrados<br><strong>${totalTaloes.toLocaleString()}</strong></div>
        
        <a href="#" class="summary-item filter-link ${currentStageFilter === 'corte' ? 'active-filter' : ''}" data-stage="corte">Corte (Faltando)<br><strong>${corte.toLocaleString()}</strong></a>
        <a href="#" class="summary-item filter-link ${currentStageFilter === 'costura' ? 'active-filter' : ''}" data-stage="costura">Costura (Faltando)<br><strong>${costura.toLocaleString()}</strong></a>
        <a href="#" class="summary-item filter-link ${currentStageFilter === 'distribuicao' ? 'active-filter' : ''}" data-stage="distribuicao">Distribuição (Faltando)<br><strong>${distribuicao.toLocaleString()}</strong></a>
        <a href="#" class="summary-item filter-link ${currentStageFilter === 'talonagem' ? 'active-filter' : ''}" data-stage="talonagem">Talonagem (Faltando)<br><strong>${talonagem.toLocaleString()}</strong></a>
        <a href="#" class="summary-item filter-link ${currentStageFilter === 'montagem' ? 'active-filter' : ''}" data-stage="montagem">Montagem (Faltando)<br><strong>${montagem.toLocaleString()}</strong></a>
      `;
    }

    function getTipoClienteClass(tipo){ switch(tipo){ case 'Exportacao': return 'exportacao-row'; case 'Cliente especial': return 'cliente-especial-row'; case 'Mercado Interno': return 'mercado-interno-row'; case 'Estoque': return 'estoque-row'; case 'Amostra': return 'amostra-row'; default: return ''; } }
    
    function etapaCell(etapa, addSep, stageName){ 
      if(etapa.paresFaltando===0 && etapa.allDone && etapa.maxDate){ 
        return `<td colspan="2" class="${addSep? 'separator-border':''} col-${stageName}"><span class="status-check">✔ ${formatDateAbreviado(etapa.maxDate)}</span></td>`; 
      } 
      return `<td class="col-${stageName}">${etapa.paresFaltando}</td><td class="col-${stageName} ${addSep? 'separator-border':''}">${etapa.taloesFaltando}</td>`; 
    }

    function renderTable(data){ 
      cronogramaTableBody.innerHTML=''; 
      const keys=Object.keys(data).sort((a,b)=>{ 
        const da=data[a].dataCorte||'9999-12-31', db=data[b].dataCorte||'9999-12-31'; 
        if(da!==db) return da.localeCompare(db); 
        const la=parseInt(String(data[a].linha).replace(/\\D/g,''))||0; 
        const lb=parseInt(String(data[b].linha).replace(/\\D/g,''))||0; 
        if(la!==lb) return la-lb; 
        const ra=parseInt(String(data[a].remessa).replace(/\\D/g,''))||0; 
        const rb=parseInt(String(data[b].remessa).replace(/\\D/g,''))||0; 
        return ra-rb; 
      }); 

      if(keys.length===0){ noData.style.display='block'; return; }

      const filteredKeys = [];

      keys.forEach(k => {
        const grp = data[k];
        let showRow = true;

        if (currentStageFilter) {
            // Se houver um filtro de etapa ativo, só mostra a linha se houver talões faltando naquela etapa
            if (grp[currentStageFilter].taloesFaltando === 0) {
                showRow = false; 
            }
        }
        
        if (showRow) {
            filteredKeys.push(k);
        }
      });
      
      if (filteredKeys.length === 0 && currentStageFilter) {
          cronogramaTableBody.innerHTML = `<tr><td colspan="16" style="text-align:center;">Nenhuma remessa encontrada com a etapa de **${currentStageFilter.toUpperCase()}** em aberto.</td></tr>`;
          return;
      }

      filteredKeys.forEach(k=>{ 
        const grp=data[k]; 
        const tr=document.createElement('tr'); 
        tr.className=getTipoClienteClass(grp.tipoCliente); 
        
        const remessaCell=`<td class="col-remessa"><a href="#" class="remessa-link" data-remessa="${grp.remessa}">${grp.remessa}</a></td>`; 
        let html=`
          <td class="col-linha">${grp.linha}</td>
          ${remessaCell}
          <td class="col-pares-ident">${grp.paresTotal.toLocaleString()}</td>
          <td class="col-taloes-ident">${grp.taloesTotal.toLocaleString()}</td>
          <td class="col-data-corte">${formatDateAbreviado(grp.dataCorte)}</td>
          <td class="col-data-entrega">${formatDateAbreviado(grp.dataEntrega)}</td>
        `;
        
        html += etapaCell(grp.corte,true, 'corte'); 
        html += etapaCell(grp.costura,true, 'costura'); 
        html += etapaCell(grp.distribuicao,true, 'distribuicao'); 
        html += etapaCell(grp.talonagem,true, 'talonagem');
        
        if(grp.montagem.paresFaltando===0 && grp.montagem.allDone && grp.montagem.maxDate){ 
          html += `<td colspan="2" class="col-montagem"><span class="status-check">✔ ${formatDateAbreviado(grp.montagem.maxDate)}</span></td>`; 
        } else { 
          html += `<td class="col-montagem">${grp.montagem.paresFaltando}</td><td class="col-montagem">${grp.montagem.taloesFaltando}</td>`; 
        }
        tr.innerHTML=html; cronogramaTableBody.appendChild(tr);
      }); 
    }
    
    // === FUNÇÕES DO MODAL DE DETALHES DA REMESSA (TABELA) ===
    
    // Define a estrutura HTML padrão para a tabela de detalhes
    function setupModalForDetails() {
        modalBodyContent.innerHTML = `
            <div id="detailsTableContainer">
                <table class="modal-body-table">
                    <thead>
                        <tr>
                        <th>Talão</th><th>Linha</th><th>Modelo</th><th>Pares</th><th>Cor</th><th>Data Corte</th><th>Ateliê</th>
                        <th>Corte</th><th>Entrada Ateliê</th><th>Saída Costura</th><th>Distribuição</th><th>Talonagem</th><th>Montagem</th><th>Trilho</th>
                        </tr>
                    </thead>
                    <tbody id="modalTableBody"></tbody>
                </table>
            </div>
        `;
        // Atualiza a referência global para o novo tbody
        modalTableBody = document.getElementById('modalTableBody'); 
    }

    // Preenche e exibe o modal de detalhes (tabela)
    function showDetailsModal(remessa){ 
      setupModalForDetails(); // Garante que a estrutura da tabela está no modal
      modalTitle.textContent=`Detalhes da Remessa: ${remessa}`; 
      modalTableBody.innerHTML=''; 
      // É importante usar allFetchedTaloes aqui para mostrar todos os detalhes da remessa, ignorando o filtro de linha
      const list=allFetchedTaloes.filter(t=>t.numeroRemessa===remessa); 
      if(list.length===0){ 
        modalTableBody.innerHTML = `<tr><td colspan="14" style="text-align:center;">Nenhum detalhe encontrado para esta remessa.</td></tr>`; 
        detailsModal.style.display='block'; 
        return; 
      } 
      list.sort((a,b)=> (parseInt(a.numeroTalaoSequencial,10)||0) - (parseInt(b.numeroTalaoSequencial,10)||0)); 
      list.forEach(t=>{ const hasCab=hasDate(t.cabedalData), hasFor=hasDate(t.forroData), hasAvi=hasDate(t.aviamentoData); let fechamentoISO=null; if(hasCab&&hasFor&&hasAvi){ fechamentoISO=[t.cabedalData,t.forroData,t.aviamentoData].reduce((m,cur)=>maxISO(m,cur),null); }
        const tr=document.createElement('tr'); 
        tr.innerHTML = `
          <td>${t.numeroTalaoSequencial||''}</td>
          <td>${t.linha||''}</td>
          <td>${t.modelo||''}</td>
          <td>${t.pares||''}</td>
          <td>${t.corSapato||''}</td>
          <td>${t.dataCorte? ` ${formatDateAbreviado(t.dataCorte)}` : ''}</td>
          <td>${t.idAtelieResponsavel||''}</td>
          <td>${fechamentoISO? `✔ ${formatDateAbreviado(fechamentoISO)}` : ''}</td>
          <td>${t.costuraDataInicio? `✔ ${formatDateAbreviado(t.costuraDataInicio)}` : ''}</td>
          <td>${t.dataSaidaCostura? `✔ ${formatDateAbreviado(t.dataSaidaCostura)}` : ''}</td>
          <td>${t.dataEntradaDistribuicao? `✔ ${formatDateAbreviado(t.dataEntradaDistribuicao)}` : ''}</td>
          <td>${t.dataEntradaTalonagem? `✔ ${formatDateAbreviado(t.dataEntradaTalonagem)}` : ''}</td>
          <td>${t.dataEntradaMontagem? `✔ ${formatDateAbreviado(t.dataEntradaMontagem)}` : ''}</td>
          <td>${t.trilhoProduzido||''}</td>
        `;
        modalTableBody.appendChild(tr); 
      }); 
      detailsModal.style.display='block'; 
    }
          
    // === Lógica dos Botões de Resumo (Cards) ===

    function checkTaloesAndAlert(){
        if (getCurrentFilteredTaloes().length === 0){
            alert('Nenhum talão carregado ou selecionado nos filtros. Por favor, use o botão "Gerar Relatório" e selecione as linhas/remessas desejadas.');
            return false;
        }
        return true;
    }
    
    // Função genérica para exibir o resumo em formato de cards
    function displayResumoCards(title, cardData, grandTotalOverride = null) {
        modalTitle.textContent = title;
        
        let totalGeral = 0; 
        
        // Altera o conteúdo do modalBodyContent para a estrutura de cards
        let htmlContent = '<div class="resumo-cards-wrapper">'; 
        
        // Verifica se há dados a serem exibidos (pelo menos um item em qualquer um dos cards)
        const hasCardItems = cardData.some(card => Object.keys(card.items).length > 0);

        if (cardData.length === 0 || !hasCardItems) {
            htmlContent = `<p style="text-align:center; font-size:1.1em; padding:15px;">Nenhum item encontrado para o resumo com as linhas selecionadas.</p>`;
        } else {
            cardData.forEach(card => {
                const models = card.items;
                const sortedModels = Object.keys(models).sort((a, b) => a.localeCompare(b));
                let modelListHtml = '<div class="model-list">';
                let totalParesCard = 0;

                sortedModels.forEach(model => {
                    modelListHtml += `<p><span>${model}</span><span>${models[model].toLocaleString()} pares</span></p>`;
                    totalParesCard += models[model];
                });
                
                modelListHtml += `<p class="card-total"><span>Total de pares:</span><span>${totalParesCard.toLocaleString()} pares</span></p>`;
                modelListHtml += '</div>';

                htmlContent += `
                    <div class="atelie-card" style="background-color: ${card.cardColor || '#f0f0f0'};">
                        <h4>${card.title}</h4>
                        ${modelListHtml}
                    </div>
                `;
            });
            
            // Cálculo do total geral
            totalGeral = grandTotalOverride !== null 
                ? grandTotalOverride 
                : (cardData[0] ? Object.values(cardData[0].items).reduce((sum, pares) => sum + pares, 0) : 0);
            
            // Card de Total Geral (sempre no final)
            htmlContent += `
                <div class="atelie-card" style="grid-column: 1 / -1; background-color: #bdbdbd; text-align: right;">
                    <h4 style="border-bottom: 0; padding-bottom: 0; font-size: 1.2em; color: var(--ink);">Total de pares: <strong style="color: var(--ink);">${totalGeral.toLocaleString()} pares</strong></h4>
                </div>
            `;

            htmlContent += '</div>';
        }
        
        modalBodyContent.innerHTML = htmlContent;
        detailsModal.style.display = 'block';
    }

    // MODIFICADO: Passa a lista filtrada
    resumoCorteButton.addEventListener('click', () => {
        if (checkTaloesAndAlert()) {
            showResumoCorteModal(getCurrentFilteredTaloes());
        }
    });

    // MODIFICADO: Passa a lista filtrada
    resumoCosturaButton.addEventListener('click', () => {
        if (checkTaloesAndAlert()) {
            showResumoCosturaModal(getCurrentFilteredTaloes());
        }
    });

    // MODIFICADO: Passa a lista filtrada
    resumoGiroFabricaButton.addEventListener('click', () => {
        if (checkTaloesAndAlert()) {
            showResumoGiroFabricaModal(getCurrentFilteredTaloes());
        }
    });

    function showResumoCorteModal(taloes) {
        // Pares faltando: pelo menos 1 etapa de corte não foi concluída
        const faltamCorte = taloes.filter(t => 
            !hasDate(t.cabedalData) || !hasDate(t.forroData) || !hasDate(t.aviamentoData)
        );
        
        // Cálculo do total de pares no corte
        const totalFaltando = faltamCorte.reduce((sum, t) => sum + (Number(t.pares) || 0), 0);
        
        // Card 1: Modelo.Linha
        const faltamML = groupAndSum(faltamCorte, t => `${t.linha}.${t.modelo}`);

        // Card 2: Linha
        const faltamL = groupAndSum(faltamCorte, t => t.linha);

        const cardData = [
            {
                title: 'Falta Cortar por modelo',
                items: faltamML,
                cardColor: '#bdbdbd' // Vermelho/Rosa Claro
            },
            {
                title: 'Flata Cortar por Linha',
                items: faltamL,
                cardColor: '#bdbdbd' // Amarelo Suave
            }
        ];

        // NOVO: Coleta e anexa os filtros ao título
        const appliedFilters = getAppliedFiltersText();
        const modalTitleText = `Pares no Corte ${appliedFilters}`;

        displayResumoCards(modalTitleText, cardData, totalFaltando); 
    }

    function showResumoCosturaModal(taloes) {
        // Pares faltando: não saiu da costura
        const faltamCosturar = taloes.filter(t => !hasDate(t.dataSaidaCostura));
        
        // Cálculo do total de pares na costura
        const totalFaltando = faltamCosturar.reduce((sum, t) => sum + (Number(t.pares) || 0), 0);

        // Agrupar por Ateliê > Linha.Modelo
        const groupedByAtelie = {};
        faltamCosturar.forEach(t => {
            const atelie = t.idAtelieResponsavel || 'Sem Atelier';
            const key = `${t.linha}.${t.modelo}`;
            const pares = Number(t.pares) || 0;

            if (!groupedByAtelie[atelie]) {
                groupedByAtelie[atelie] = {};
            }
            groupedByAtelie[atelie][key] = (groupedByAtelie[atelie][key] || 0) + pares;
        });

        // Mapear para o formato displayResumoCards
        const cardData = Object.keys(groupedByAtelie).sort((a, b) => a.localeCompare(b)).map(atelie => {
            return {
                title: `${atelie}`, 
                items: groupedByAtelie[atelie],
                cardColor: '#bdbdbd' // Amarelo Padrão para Costura/Alerta
            };
        });
        
        // NOVO: Coleta e anexa os filtros ao título
        const appliedFilters = getAppliedFiltersText();
        const modalTitleText = `Resumo: Pares Faltando na Costura (por Ateliê) ${appliedFilters}`;

        displayResumoCards(modalTitleText, cardData, totalFaltando);
    }

    function showResumoGiroFabricaModal(taloes) {
        
        // 1. Disponível para Montar (Entrou em Dist. ou Tal. E Não entrou em Mont.)
        const disponivelTaloes = taloes.filter(t => 
            (hasDate(t.dataEntradaDistribuicao) || hasDate(t.dataEntradaTalonagem)) && 
            !hasDate(t.dataEntradaMontagem)
        );
        
        // Cálculo do total de pares disponíveis (Conjunto principal)
        const totalDisponivel = disponivelTaloes.reduce((sum, t) => sum + (Number(t.pares) || 0), 0);
        
        // 2. Talonado (Entrou em Tal. E Não entrou em Mont.)
        const talonadoTaloes = taloes.filter(t => 
            hasDate(t.dataEntradaTalonagem) && 
            !hasDate(t.dataEntradaMontagem)
        );

        // Card 1: Disponível Modelo.Linha
        const disponivelML = groupAndSum(disponivelTaloes, t => `${t.linha}.${t.modelo}`);

        // Card 2: Talonado Modelo.Linha
        const talonadoML = groupAndSum(talonadoTaloes, t => `${t.linha}.${t.modelo}`);
        
        // Card 3: Disponível Linha
        const disponivelL = groupAndSum(disponivelTaloes, t => t.linha);

        // NOVO Card 4: Talonado Linha (Exatamente igual ao Talonado, mas agrupado por linha)
        const talonadoL = groupAndSum(talonadoTaloes, t => t.linha);


        const cardData = [
            {
                title: 'Na Fabrica por modelo',
                items: disponivelML,
                cardColor: '#bdbdbd' // Verde Claro (Pronto/Estoque)
            },
            {
                title: 'Talonado por Modelo',
                items: talonadoML,
                cardColor: '#bdbdbd' // Laranja Claro (Em Etapa Chave)
            },
            {
                title: 'Na Fabrica por Linha',
                items: disponivelL,
                cardColor: '#bdbdbd' // Azul Claro (Resumo Linha)
            },
            {
                title: 'Talonado por Linha', 
                items: talonadoL,         
                cardColor: '#bdbdbd'      // Rosa Claro (Destaque para o subconjunto)
            }
        ];
        
        // Coleta e anexa os filtros ao título
        const appliedFilters = getAppliedFiltersText();
        const modalTitleText = `Giro fabrica: ${appliedFilters}`;

        displayResumoCards(modalTitleText, cardData, totalDisponivel); 
    }
    
    // Event listener para clique no link da remessa (chama o modal de detalhes)
    document.addEventListener('click',(e)=>{ 
        const a=e.target.closest('.remessa-link'); 
        if(a){ 
            e.preventDefault(); 
            showDetailsModal(a.dataset.remessa); 
        }
    });
    
    // Listeners do Modal de Detalhes
    closeModalBtn.addEventListener('click',()=> detailsModal.style.display='none');
    window.addEventListener('click',(e)=>{ if(e.target===detailsModal) detailsModal.style.display='none'; });

    // NOVO: Listeners do Modal de Filtro de Remessa
    remessaCloseBtn.addEventListener('click',()=> remessaFilterModal.style.display='none');
    window.addEventListener('click',(e)=>{ if(e.target===remessaFilterModal) remessaFilterModal.style.display='none'; });
    
    selectRemessasButton.addEventListener('click', openRemessaFilterModal);

    // Event Listener para "Salvar Seleção" do filtro de remessa
    saveRemessaSelectionButton.addEventListener('click', handleRemessaFilterSave);

    // Event Listener para "Selecionar Todos" do filtro de remessa
    selectAllRemessas.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        document.querySelectorAll('#remessaFilterTableBody .remessa-checkbox').forEach(cb => {
            cb.checked = isChecked;
        });
    });

    function openRemessaFilterModal() {
        if (availableRemessas.size === 0) {
            alert("Nenhuma remessa disponível para filtrar. Gere o relatório primeiro.");
            return;
        }

        remessaFilterTableBody.innerHTML = '';
        const sortedRemessas = Array.from(availableRemessas.keys()).sort((a, b) => a.localeCompare(b));
        let allChecked = true;

        sortedRemessas.forEach(remessa => {
            const data = availableRemessas.get(remessa);
            const isChecked = selectedRemessas.has(remessa);
            
            if (!isChecked) allChecked = false;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" class="remessa-checkbox" value="${remessa}" ${isChecked ? 'checked' : ''}></td>
                <td style="text-align: left;">${remessa}</td>
                <td style="text-align: left;">${Array.from(data.linhas).sort().join(', ')}</td>
                <td>${data.pares.toLocaleString()}</td>
                <td>${Array.from(data.tiposCliente).join(', ')}</td>
            `;
            remessaFilterTableBody.appendChild(tr);
        });
        
        // Atualiza o checkbox "Selecionar Todos"
        selectAllRemessas.checked = allChecked;

        remessaFilterModal.style.display = 'block';
    }

    function handleRemessaFilterSave() {
        // 1. Coleta a nova seleção
        const newSelectedRemessas = new Set();
        document.querySelectorAll('#remessaFilterTableBody .remessa-checkbox:checked').forEach(cb => {
            newSelectedRemessas.add(cb.value);
        });
        
        // 2. Atualiza o estado
        selectedRemessas = newSelectedRemessas;
        
        // 3. Fecha o modal e atualiza a contagem
        remessaFilterModal.style.display = 'none';
        updateRemessaCountDisplay();
        
        // 4. Re-gera o relatório
        filterAndGenerateReport();
    }
    
    
    document.addEventListener('click', (e) => {
        const link = e.target.closest('.filter-link');
        if (link) {
            e.preventDefault();
            const stage = link.dataset.stage; 
            currentStageFilter = (currentStageFilter === stage) ? null : stage;
            if (allFetchedTaloes.length > 0) {
                // Ao mudar o filtro de etapa, re-renderiza o relatório com os talões de linha já filtrados.
                filterAndGenerateReport();
            } else {
                runSearch(); 
            }
        }
    });
          
    // === Lógica de Ocultar/Expandir Colunas com Checkbox ===

    const COLUMN_DEFS = [
        { label: 'Linha', selectors: ['.col-linha'], defaultChecked: true },
        { label: 'Remessa', selectors: ['.col-remessa'], defaultChecked: true },
        { label: 'Pares', selectors: ['.col-pares-ident'], defaultChecked: true },
        { label: 'Talões', selectors: ['.col-taloes-ident'], defaultChecked: true },
        { label: 'Data de Corte', selectors: ['.col-data-corte'], defaultChecked: true },
        { label: 'Data de Entrega', selectors: ['.col-data-entrega'], defaultChecked: true },
        { label: 'Corte', selectors: ['.col-corte-group', '.col-corte'], defaultChecked: true },
        { label: 'Costura', selectors: ['.col-costura-group', '.col-costura'], defaultChecked: true },
        { label: 'Distribuição', selectors: ['.col-distribuicao-group', '.col-distribuicao'], defaultChecked: true },
        { label: 'Talonagem', selectors: ['.col-talonagem-group', '.col-talonagem'], defaultChecked: true },
        { label: 'Montagem', selectors: ['.col-montagem-group', '.col-montagem'], defaultChecked: true },
    ];

    function setupColumnControl() {
        if (!checkboxContainer) return;
        checkboxContainer.innerHTML = ''; 

        COLUMN_DEFS.forEach(col => {
            const id = `toggle-${col.selectors[0].substring(1).replace('-group','')}`;
            
            const label = document.createElement('label');
            label.htmlFor = id;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = id;
            checkbox.checked = col.defaultChecked;
            checkbox.dataset.selectors = col.selectors.join(','); 

            checkbox.addEventListener('change', (e) => {
                const selectors = e.target.dataset.selectors.split(',');
                const isChecked = e.target.checked;
                
                selectors.forEach(selector => {
                    const elements = document.querySelectorAll(`th${selector}, td${selector}`);
                    elements.forEach(el => {
                        el.classList.toggle('hidden-column', !isChecked);
                    });
                });
            });

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(col.label));
            checkboxContainer.appendChild(label);

            if (!col.defaultChecked) {
                col.selectors.forEach(selector => {
                    document.querySelectorAll(`th${selector}, td${selector}`).forEach(el => {
                        el.classList.add('hidden-column');
                    });
                });
            }
        });
    }

  </script>
</body>
</html>
