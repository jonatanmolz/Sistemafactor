<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excluir Dados - SistemaTaloes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        header h1 {
            margin: 0;
            font-size: 24px;
        }
        .user-info {
            font-size: 14px;
            text-align: right;
        }
        .user-info span {
            display: block;
            font-weight: bold;
        }
        nav {
            background-color: #555;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.8em
        }
        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
            display: block;
        }
        nav ul li a:hover {
            background-color: #777;
        }
        .main-content {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .delete-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 600px;
            margin-top: 20px;
        }
        h2 {
            text-align: center;
            color: #dc3545;
            margin-bottom: 20px;
        }
        .delete-section {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .form-group label {
            font-weight: bold;
            margin-bottom: 8px;
        }
        .form-group input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
            width: 100%;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .message-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            display: none; /* Escondido por padrão */
        }
        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button#logoutButton {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 2px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        button#logoutButton:hover {
            background-color: #c82333;
        }
        @media (max-width: 768px) {
            .delete-container {
                width: 95%;
                padding: 15px;
            }
            .delete-btn {
                padding: 15px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>SistemaTaloes</h1>
        <div class="user-info">
            <span id="userNameDisplay">Carregando...</span>
            <span id="userNivelDisplay"></span>
        </div>
        <div>
            <button id="logoutButton">Sair</button>
        </div>
    </header>

    <nav>
        <ul id="menuNav">
            </ul>
    </nav>

    <div class="main-content">
        <div class="delete-container">
            <h2>Exclusão de Dados em Massa</h2>
            <div class="delete-section">
                <h3>Excluir por Data de Corte</h3>
                <p><strong>Atenção:</strong> Esta ação é irreversível e irá deletar todos os talões da data selecionada.</p>
                <div class="form-group">
                    <label for="deleteDateInput">Selecione a Data de Corte:</label>
                    <input type="date" id="deleteDateInput">
                </div>
                <button class="delete-btn" id="deleteByDateBtn">Excluir por Data</button>
            </div>

            <div class="delete-section">
                <h3>Excluir por Remessa</h3>
                <p><strong>Atenção:</strong> Esta ação é irreversível e irá deletar todos os talões da remessa selecionada.</p>
                <div class="form-group">
                    <label for="deleteRemessaInput">Digite o Número da Remessa:</label>
                    <input type="text" id="deleteRemessaInput" placeholder="Ex: 001">
                </div>
                <button class="delete-btn" id="deleteByRemessaBtn">Excluir por Remessa</button>
            </div>

            <div id="messageBox" class="message-box"></div>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyCLb8BeZODM8vMynaIXINx4AN_P8snTBk8",
            authDomain: "sistemataloes.firebaseapp.com",
            projectId: "sistemataloes",
            storageBucket: "sistemataloes.appspot.com",
            messagingSenderId: "684534379685",
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
        // CORREÇÃO: getDoc foi adicionado à lista de importações
        import { getFirestore, collection, query, where, getDocs, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Elementos do Header e Navegação
        const menuNav = document.getElementById('menuNav');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const userNivelDisplay = document.getElementById('userNivelDisplay');
        const logoutButton = document.getElementById('logoutButton');

        // Elementos da Página de Exclusão
        const deleteDateInput = document.getElementById('deleteDateInput');
        const deleteRemessaInput = document.getElementById('deleteRemessaInput');
        const deleteByDateBtn = document.getElementById('deleteByDateBtn');
        const deleteByRemessaBtn = document.getElementById('deleteByRemessaBtn');
        const messageBox = document.getElementById('messageBox');

    // Tipos de Usuarios e niveis
        const nivelNomes = {
            '01': 'Cadastro',
            '02': 'Corte',
            '03': 'Costura',
            '04': 'Montagem',
            '05': 'Admin',
            '06': 'Consultor',
            '07':'Super'

        };

        // Definição das páginas e seus níveis de acesso (copiado do index.html)
        const pages = [
          // Inicio
            { name: 'Index', href: 'index.html', levels: ['01','02','03', '04','05', '06','07'] },
          // Cadastro
            { name: 'Cadastro Usuarios', href: 'cadastroUsuarios.html', levels: ['07'] },
            { name: 'Cadastro Talões', href: 'cadastroTaloes.html', levels: ['01', '05','07'] },

          // Ferramentas
            { name: 'Romaneio', href: 'romaneio.html', levels: ['05','07'] },
            { name: 'Excluir Dados', href: 'excluirDados.html', levels: ['05','07'] },
            { name: 'Registro em Massa', href: 'registroEmMassa.html', levels: ['07'] },
          
          // Corte
            { name: 'Corte', href: 'corte.html', levels: ['02','07'] },
            { name: 'Relatório Erros', href: 'relatorioerros.html', levels: ['02','04','07'] },

          // Relatorios
            { name: 'Resumo', href: 'resumo.html', levels: ['04','06','07'] },
            { name: 'Cronograma', href: 'cronograma.html', levels: ['01','02', '04','05','06','07'] },
            { name: 'Cronograma Mobile', href: 'cronogramamobile.html', levels: ['06','07'] },
            { name: 'Relatório Master', href: 'relatorioMaster.html', levels: ['05','07'] },

          //Costura
            { name: 'Costura', href: 'costura.html', levels: ['03','07'] },
            { name: 'Relatorio Atelier', href: 'relatorioAtelier.html', levels: ['03','07'] },
            { name: 'Atlier Celular', href: 'relatoriomobile.html', levels: ['03','07'] },

          // Fabrica
            { name: 'Distribuição', href: 'distribuicao.html', levels: ['04','07'] },
            { name: 'Talonagem', href: 'talonagem.html', levels: ['04','07'] },
            { name: 'Montagem', href: 'montagem.html', levels: ['05','07'] }
            
        ];

    //Funçoes


        // Função para gerar o menu dinamicamente
        function generateMenu(userLevel, userName) {
            menuNav.innerHTML = '';
            const userNivelText = nivelNomes[userLevel] || `Nível ${userLevel}`;
            userNameDisplay.textContent = `Olá, ${userName || 'Usuário'}!`;
            userNivelDisplay.textContent = `Setor: ${userNivelText}`;

            pages.forEach(page => {
                if (page.levels.includes(userLevel)) {
                    const listItem = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = page.href; 
                    link.textContent = page.name;
                    listItem.appendChild(link);
                    menuNav.appendChild(listItem);
                }
            });
        }
        
        // --- Controle de Autenticação e Carregamento de Dados ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, 'Usuario', user.email);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    const nivelAcesso = userData.nivelAcesso;

                    if (!pages.find(p => p.href === 'excluirDados.html' && p.levels.includes(nivelAcesso))) {
                        alert('Você não tem permissão para acessar esta página.');
                        window.location.href = 'index.html';
                        return;
                    }

                    generateMenu(nivelAcesso, userData.Nome);
                } else {
                    alert('Dados do usuário não encontrados. Faça login novamente.');
                    await signOut(auth);
                    window.location.href = 'login.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- Lógica de Logout ---
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                alert("Erro ao fazer logout. Tente novamente.");
            }
        });

        // --- Função para exibir mensagens ---
        function showMessage(message, isSuccess = true) {
            messageBox.textContent = message;
            messageBox.className = `message-box ${isSuccess ? 'success' : 'error'}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        // --- Função para deletar documentos em massa ---
        async function deleteDocumentsByField(field, value) {
            if (!value) {
                showMessage(`Por favor, insira um valor para ${field}.`, false);
                return;
            }

            const confirmationMessage = `Tem certeza que deseja excluir todos os talões com ${field} = "${value}"? Esta ação é IRREVERSÍVEL.`;
            if (!confirm(confirmationMessage)) {
                return;
            }

            showMessage('Excluindo documentos...', true);
            
            try {
                const taloesColRef = collection(db, 'taloes');
                const q = query(taloesColRef, where(field, '==', value));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage(`Nenhum talão encontrado com ${field} = "${value}".`, false);
                    return;
                }

                const deletePromises = [];
                querySnapshot.docs.forEach(docToDelete => {
                    deletePromises.push(deleteDoc(doc(db, 'taloes', docToDelete.id)));
                });

                await Promise.all(deletePromises);
                showMessage(`${querySnapshot.size} talões excluídos com sucesso!`);
            } catch (error) {
                console.error("Erro ao excluir documentos:", error);
                showMessage(`Erro ao excluir documentos: ${error.message}`, false);
            }
        }

        // --- Event Listeners para os botões ---
        deleteByDateBtn.addEventListener('click', () => {
            const dateValue = deleteDateInput.value;
            deleteDocumentsByField('dataCorte', dateValue);
        });

        deleteByRemessaBtn.addEventListener('click', () => {
            const remessaValue = deleteRemessaInput.value.trim();
            deleteDocumentsByField('numeroRemessa', remessaValue);
        });
    </script>
</body>
</html>